<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Saya | Manajemen Akun</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'cool-primary': '#1d4ed8',
                        'cool-accent': '#06b6d4',
                        'bg-light': '#f1f5f9',
                        'bg-dark': '#0f172a',
                        'card-light': '#ffffff',
                        'card-dark': '#1e293b',
                        'card-gray': '#f9fafb',
                        'text-light': '#f1f5f9',
                        'text-dark': '#1e293b',
                        'neutral-text': '#64748b',
                        'wa-success': '#25D366'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'scale-in': 'scaleIn 0.3s ease-out',
                        'spin-slow': 'spin 2s linear infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                    }
                }
            }
        }
    </script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Smooth Scroll */
        html {
            scroll-behavior: smooth;
        }

        /* Dark Mode Toggle Button Styles */
        .dark-mode-toggle {
            position: relative;
            width: 48px;
            height: 24px;
            border-radius: 24px;
            background: linear-gradient(to right, #fbbf24, #f59e0b);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dark .dark-mode-toggle {
            background: linear-gradient(to right, #1e293b, #334155);
        }

        .dark-mode-toggle .toggle-circle {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .dark .dark-mode-toggle .toggle-circle {
            transform: translateX(24px);
            background: #0f172a;
        }

        /* Bottom Nav Active State */
        .bottom-nav-item.active {
            color: #1d4ed8;
        }

        .bottom-nav-item {
            transition: all 0.3s ease;
        }

        /* Card Animations */
        .card-animate {
            animation: scaleIn 0.3s ease-out;
        }

        /* Sidebar Animation */
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }

        /* Hide scrollbar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Tab button active state */
        .tab-btn.active {
            color: #1d4ed8;
            border-bottom-color: #1d4ed8;
        }

        .dark .tab-btn.active {
            color: #06b6d4;
            border-bottom-color: #06b6d4;
        }
    </style>
</head>
<body class="bg-bg-light dark:bg-bg-dark font-sans transition-colors duration-300">

<!-- Header -->
<header class="bg-card-light dark:bg-card-dark shadow-lg sticky top-0 z-50 backdrop-blur-md bg-opacity-95">
    <div class="flex items-center justify-between p-4 h-16">
        <a href="home.html" class="inline-flex items-center text-cool-primary dark:text-cool-accent transition-all hover:scale-105">
            <i class="fas fa-arrow-left text-xl"></i>
        </a>

        <h1 class="absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-text-dark dark:text-text-light">
            Profil Saya
        </h1>

        <div class="flex items-center gap-2">
            <div id="darkModeToggle" class="dark-mode-toggle">
                <div class="toggle-circle">
                    <i class="fas fa-sun text-yellow-500 text-xs"></i>
                </div>
            </div>
        </div>
    </div>
</header>


    <main id="main" class="min-h-screen pb-20">
        <div class="max-w-2xl mx-auto">

            <!-- Tab Navigation -->
            <div class="bg-card-light dark:bg-card-dark sticky top-16 z-40 shadow-sm">
                <div class="flex overflow-x-auto scrollbar-hide px-2">
                    <button class="tab-btn active flex-1 min-w-fit px-4 py-4 text-sm font-semibold text-cool-primary dark:text-cool-accent border-b-2 border-cool-primary dark:border-cool-accent whitespace-nowrap transition-all" data-tab="profile">
                        <i class="fas fa-user-circle mr-2"></i>
                        Profil
                    </button>
                    <button class="tab-btn flex-1 min-w-fit px-4 py-4 text-sm font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:text-cool-primary dark:hover:text-cool-accent whitespace-nowrap transition-all" data-tab="address">
                        <i class="fas fa-map-marked-alt mr-2"></i>
                        Alamat
                    </button>
                    <button class="tab-btn flex-1 min-w-fit px-4 py-4 text-sm font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:text-cool-primary dark:hover:text-cool-accent whitespace-nowrap transition-all" data-tab="security">
                        <i class="fas fa-lock mr-2"></i>
                        Keamanan
                    </button>
                    <button class="tab-btn flex-1 min-w-fit px-4 py-4 text-sm font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:text-cool-primary dark:hover:text-cool-accent whitespace-nowrap transition-all" data-tab="orders">
                        <i class="fas fa-receipt mr-2"></i>
                        Pesanan
                    </button>
                </div>
            </div>

            <!-- Tab Content Container -->
            <div class="px-4 py-6 space-y-6">

                <!-- Tab: Profil -->
                <div id="tab-profile" class="tab-content">
                    <!-- Card Ringkasan Profil -->
                    <section class="bg-card-light dark:bg-card-dark p-4 sm:p-6 rounded-xl shadow-lg flex items-center space-x-3 sm:space-x-4 border-l-4 sm:border-l-8 border-cool-accent dark:border-cool-primary card-animate mb-6">
                        <!-- Logo Profil/Avatar -->
                        <div class="p-3 sm:p-4 bg-cool-accent/20 dark:bg-cool-primary/30 rounded-full flex-shrink-0">
                            <i class="fas fa-user-circle text-3xl sm:text-4xl text-cool-accent dark:text-cool-primary"></i>
                        </div>

                        <!-- Informasi Profil -->
                        <div class="flex-grow min-w-0">
                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Selamat datang kembali,</p>
                            <h2 id="displayUserName" class="text-xl sm:text-2xl font-bold text-text-dark dark:text-text-light truncate">Memuat...</h2>
                            <div class="mt-1 flex items-center space-x-2 sm:space-x-3 text-gray-600 dark:text-gray-400">
                                <i class="fab fa-whatsapp text-sm sm:text-base"></i>
                                <span id="displayUserPhone" class="text-xs sm:text-sm truncate">Memuat...</span>
                            </div>
                        </div>

                        <!-- Tombol Edit/Aksi -->
                        <button onclick="document.getElementById('name').focus()" class="p-2 text-cool-primary dark:text-cool-accent hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition flex-shrink-0">
                            <i class="fas fa-edit text-lg"></i>
                        </button>
                    </section>

                    <!-- Bagian Informasi Pribadi -->
                    <section class="bg-card-light dark:bg-card-dark p-4 sm:p-6 rounded-xl shadow-lg border-t-4 border-cool-primary dark:border-cool-accent card-animate">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6 text-text-dark dark:text-text-light flex items-center gap-2">
                            <i class="fas fa-user-edit text-cool-primary dark:text-cool-accent"></i>
                            Informasi Pribadi
                        </h2>

                        <form id="profileForm" class="space-y-4">
                            <div class="grid grid-cols-1 gap-4">

                                <!-- Input: Nama Lengkap -->
                                <div>
                                    <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                        <i class="fas fa-user mr-1 text-cool-primary dark:text-cool-accent"></i>
                                        Nama Lengkap
                                    </label>
                                    <input type="text" id="name"
                                           class="mt-1 block w-full px-3 sm:px-4 py-2 sm:py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-cool-primary focus:border-cool-primary dark:bg-card-dark dark:text-text-light dark:focus:ring-cool-accent dark:focus:border-cool-accent transition">
                                </div>

                                <!-- Input: Email (Non-editable) -->
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                        <i class="fas fa-envelope mr-1 text-cool-primary dark:text-cool-accent"></i>
                                        Email
                                    </label>
                                    <input type="email" id="email" disabled
                                           class="mt-1 block w-full px-3 sm:px-4 py-2 sm:py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl shadow-sm bg-gray-100 dark:bg-gray-700 cursor-not-allowed text-gray-500 dark:text-gray-400">
                                </div>

                                <!-- Input: Nomor Telepon -->
                                <div>
                                    <label for="phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                        <i class="fas fa-phone mr-1 text-cool-primary dark:text-cool-accent"></i>
                                        Nomor Telepon
                                    </label>
                                    <input type="tel" id="phone"
                                           class="mt-1 block w-full px-3 sm:px-4 py-2 sm:py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-cool-primary focus:border-cool-primary dark:bg-card-dark dark:text-text-light dark:focus:ring-cool-accent dark:focus:border-cool-accent transition">
                                </div>

                                <!-- Input: Tanggal Lahir -->
                                <div>
                                    <label for="birthdate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                        <i class="fas fa-calendar mr-1 text-cool-primary dark:text-cool-accent"></i>
                                        Tanggal Lahir
                                    </label>
                                    <input type="date" id="birthdate" value="1995-10-26"
                                           class="mt-1 block w-full px-3 sm:px-4 py-2 sm:py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-cool-primary focus:border-cool-primary dark:bg-card-dark dark:text-text-light dark:focus:ring-cool-accent dark:focus:border-cool-accent transition">
                                </div>

                            </div>

                            <div class="flex gap-2 pt-4">
                                <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-cool-primary to-blue-600 text-white font-semibold rounded-xl shadow-lg hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-cool-primary focus:ring-offset-2 dark:focus:ring-offset-bg-dark transition duration-150 transform hover:scale-105">
                                    <i class="fas fa-save mr-2"></i>
                                    Simpan
                                </button>
                                <button type="button" id="logoutBtn" class="px-6 py-3 bg-red-500 text-white font-semibold rounded-xl shadow-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 transform hover:scale-105">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                            </div>
                        </form>
                    </section>
                </div>

                <!-- Tab: Alamat -->
                <div id="tab-address" class="tab-content hidden">
                    <section class="bg-card-light dark:bg-card-dark p-4 sm:p-6 rounded-xl shadow-lg border-t-4 border-cool-accent card-animate">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 sm:mb-6 space-y-3 sm:space-y-0">
                            <h2 class="text-xl sm:text-2xl font-semibold text-text-dark dark:text-text-light flex items-center gap-2">
                                <i class="fas fa-map-marked-alt text-cool-accent"></i>
                                Alamat Pengiriman
                            </h2>
                            <button id="addAddressBtn" class="w-full sm:w-auto flex items-center justify-center px-4 py-2 sm:py-2.5 bg-gradient-to-r from-cool-accent to-cyan-500 text-white font-semibold rounded-xl shadow-lg hover:from-cyan-500 hover:to-cyan-600 focus:outline-none focus:ring-2 focus:ring-cool-accent focus:ring-offset-2 dark:focus:ring-offset-bg-dark transition duration-150 transform hover:scale-105">
                                <i class="fas fa-plus mr-2"></i> Tambah Alamat
                            </button>
                        </div>

                        <!-- Address List -->
                        <div id="addressList" class="grid grid-cols-1 gap-4">
                            <!-- Alamat akan dimuat di sini oleh JavaScript -->
                            <p id="loadingAddress" class="text-gray-500 dark:text-gray-400 col-span-full flex items-center gap-2">
                                <i class="fas fa-spinner fa-spin"></i>
                                Memuat alamat...
                            </p>
                        </div>
                    </section>
                </div>

                <!-- Tab: Keamanan -->
                <div id="tab-security" class="tab-content hidden">
                    <section class="bg-card-light dark:bg-card-dark p-4 sm:p-6 rounded-xl shadow-lg border-t-4 border-orange-500 card-animate">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6 text-text-dark dark:text-text-light flex items-center gap-2">
                            <i class="fas fa-lock text-orange-500"></i>
                            Keamanan Akun
                        </h2>
                        <div class="text-center py-12">
                            <i class="fas fa-shield-alt text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">Fitur keamanan akan segera hadir</p>
                        </div>
                    </section>
                </div>

                <!-- Tab: Pesanan -->
                <div id="tab-orders" class="tab-content hidden">
                    <section class="bg-card-light dark:bg-card-dark p-4 sm:p-6 rounded-xl shadow-lg border-t-4 border-green-500 card-animate">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6 text-text-dark dark:text-text-light flex items-center gap-2">
                            <i class="fas fa-receipt text-green-500"></i>
                            Riwayat Pesanan
                        </h2>
                        <div class="text-center py-12">
                            <i class="fas fa-shopping-bag text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">Belum ada pesanan</p>
                        </div>
                    </section>
                </div>

            </div>
        </div>
    </main>

    <!-- Modal Tambah/Edit Alamat -->
    <div id="addressModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-card-light dark:bg-card-dark rounded-xl shadow-2xl max-w-lg w-full p-6 transform transition-all scale-100 opacity-100">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-xl font-bold text-text-dark dark:text-text-light">Tambah Alamat Baru</h3>
                <button id="closeAddressModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-2">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <form id="addressFormModal" class="space-y-4">
                <div>
                    <label for="addressLabel" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Label Alamat (cth: Rumah, Kantor)</label>
                    <input type="text" id="addressLabel" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-cool-primary focus:border-cool-primary dark:bg-card-dark dark:text-text-light">
                </div>
                <div>
                    <label for="receiverName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nama Penerima</label>
                    <input type="text" id="receiverName" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-cool-primary focus:border-cool-primary dark:bg-card-dark dark:text-text-light">
                </div>
                <div>
                    <label for="fullAddress" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Alamat Lengkap</label>
                    <textarea id="fullAddress" rows="3" required
                              class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-cool-primary focus:border-cool-primary dark:bg-card-dark dark:text-text-light"></textarea>
                </div>
                
                <div class="flex justify-end pt-4">
                    <button type="submit" class="w-full px-4 py-2 bg-cool-primary text-white font-semibold rounded-xl hover:bg-blue-700 transition duration-150">
                        Simpan Alamat
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-card-light dark:bg-card-dark rounded-xl shadow-2xl max-w-sm w-full p-6 text-center transform transition-all">
            <i class="fas fa-exclamation-triangle fa-3x text-red-500 mb-4"></i>
            <h3 class="text-xl font-bold mb-2 text-text-dark dark:text-text-light">Konfirmasi Penghapusan</h3>
            <p class="mb-6 text-gray-600 dark:text-gray-400">Anda yakin ingin menghapus alamat ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-text-dark dark:text-text-light rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition">Batal</button>
                <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 transition">Hapus</button>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi Logout -->
    <div id="logoutConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-card-light dark:bg-card-dark rounded-xl shadow-2xl max-w-sm w-full p-6 text-center transform transition-all">
            <i class="fas fa-sign-out-alt fa-3x text-cool-primary dark:text-cool-accent mb-4"></i>
            <h3 class="text-xl font-bold mb-2 text-text-dark dark:text-text-light">Siap untuk Logout?</h3>
            <p class="mb-6 text-gray-600 dark:text-gray-400">Pilih "Logout" di bawah jika Anda siap mengakhiri sesi Anda saat ini.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelLogoutBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-text-dark dark:text-text-light rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition">Batal</button>
                <button id="confirmLogoutBtn" class="px-4 py-2 bg-cool-primary text-white rounded-xl hover:bg-blue-700 transition">Logout</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation (Mobile Only) -->
    <footer class="lg:hidden fixed bottom-0 left-0 right-0 bg-card-light dark:bg-card-dark border-t border-gray-200 dark:border-gray-700 shadow-2xl z-50 backdrop-blur-md bg-opacity-95">
        <div class="flex justify-around items-center h-16">
            <a href="home.html" class="bottom-nav-item text-neutral-text dark:text-gray-400 hover:text-cool-primary flex flex-col items-center text-xs font-medium">
                <i class="fas fa-home text-xl mb-1"></i>
                <span>Beranda</span>
            </a>
            <a href="kuliner.html" class="bottom-nav-item text-neutral-text dark:text-gray-400 hover:text-cool-primary flex flex-col items-center text-xs font-medium">
                <i class="fas fa-search text-xl mb-1"></i>
                <span>Cari</span>
            </a>
            <a href="#" class="bottom-nav-item text-neutral-text dark:text-gray-400 hover:text-cool-primary flex flex-col items-center text-xs font-medium">
                <i class="fas fa-list-alt text-xl mb-1"></i>
                <span>Pesanan</span>
            </a>
            <a href="profile.html" class="bottom-nav-item active text-cool-primary flex flex-col items-center text-xs font-semibold">
                <i class="fas fa-user text-xl mb-1"></i>
                <span>Akun</span>
            </a>
        </div>
    </footer>

    <!-- Notification Popup -->
    <div id="notification-popup" class="fixed top-20 right-4 z-[9999] max-w-sm w-full transform transition-all duration-300 opacity-0 translate-y-2 hidden">
        <div class="bg-white dark:bg-card-dark rounded-xl shadow-2xl p-4 flex items-center space-x-3 border-l-4">
            <div id="notification-icon" class="flex-shrink-0"></div>
            <p id="notification-text" class="text-sm font-medium flex-grow"></p>
            <button onclick="showMessage.dismiss()" class="flex-shrink-0 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
<script src="config.js"></script>
<script>// --- Perbaikan dan Penyesuaian Kode JavaScript ---
// ===================================
// KONSTANTA DAN INISIALISASI
// ===================================

// Objek untuk menampung referensi elemen DOM
const elements = {};

// State Aplikasi Global (Simulasi data dari backend)
let appState = {
    userName: 'Memuat...',
    userEmail: 'Memuat...',
    userPhone: 'Memuat...',
    userBirthdate: '1995-10-26', // Akan diisi jika ada di backend
    addresses: [] // Data alamat yang akan dimuat
};

// State sementara untuk ID alamat yang akan dihapus
let deleteTargetId = null;

// ===================================
// FUNGSI UTILITY DEBUGGING BARU
// ===================================

/**
 * Fungsi untuk logging pesan debug yang konsisten
 * @param {string} message - Pesan yang akan dicetak di console.
 * @param {string} type - Tipe log ('info', 'warn', 'error', 'debug').
 */
function logDebug(message, type = 'debug') {
    const timestamp = new Date().toLocaleTimeString();
    const typeUpper = type.toUpperCase();
    switch (type) {
        case 'info':
            console.info(`[${typeUpper} - ${timestamp}] ${message}`);
            break;
        case 'warn':
            console.warn(`[${typeUpper} - ${timestamp}] ${message}`);
            break;
        case 'error':
            console.error(`[${typeUpper} - ${timestamp}] ${message}`);
            break;
        case 'debug':
        default:
            console.log(`[${typeUpper} - ${timestamp}] ${message}`);
            break;
    }
}

// Ambil Token dari localStorage
function getAuthToken() {
    const authToken = localStorage.getItem('authToken');
    logDebug(`Mengecek AuthToken. Ditemukan: ${!!authToken}`, 'debug');
    return authToken; 
}

// --- Fungsi Utilitas & UI ---

function initElements() {
    logDebug('Menginisialisasi elemen DOM (initElements)', 'info');
    elements.body = document.body;

    // Display Elements
    elements.displayUserName = document.getElementById('displayUserName');
    elements.displayUserPhone = document.getElementById('displayUserPhone');
    elements.inputName = document.getElementById('name');
    elements.inputEmail = document.getElementById('email');
    elements.inputPhone = document.getElementById('phone');
    elements.inputBirthdate = document.getElementById('birthdate');

    // Modals
    elements.addressModal = document.getElementById('addressModal');
    elements.closeAddressModal = document.getElementById('closeAddressModal');
    elements.addAddressBtn = document.getElementById('addAddressBtn');
    elements.addressList = document.getElementById('addressList');
    elements.addressFormModal = document.getElementById('addressFormModal');
    elements.loadingAddress = document.getElementById('loadingAddress');

    elements.deleteConfirmModal = document.getElementById('deleteConfirmModal');
    elements.confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    elements.cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

    elements.logoutConfirmModal = document.getElementById('logoutConfirmModal');
    elements.confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
    elements.cancelLogoutBtn = document.getElementById('cancelLogoutBtn');

    elements.profileForm = document.getElementById('profileForm');

    // Elemen modal alamat
    elements.modalTitle = document.getElementById('modalTitle');
    elements.addressLabel = document.getElementById('addressLabel');
    elements.receiverName = document.getElementById('receiverName');
    elements.fullAddress = document.getElementById('fullAddress');
}


function showModal(modalElement) {
    logDebug(`Menampilkan Modal: ${modalElement.id}`);
    modalElement.classList.remove('hidden');
}

function hideModal(modalElement) {
    logDebug(`Menyembunyikan Modal: ${modalElement.id}`);
    modalElement.classList.add('hidden');
    modalElement.classList.remove('flex');
    elements.body.classList.remove('overflow-hidden'); 
}

function toggleSidebar() {
    // Function removed - no longer needed
}

// ========== TAB SWITCHING ==========
function switchTab(tabName) {
    logDebug(`Switching to tab: ${tabName}`, 'info');

    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });

    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active', 'text-cool-primary', 'dark:text-cool-accent', 'border-cool-primary', 'dark:border-cool-accent', 'font-semibold');
        btn.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent', 'font-medium');
    });

    // Show selected tab content
    const selectedContent = document.getElementById(`tab-${tabName}`);
    if (selectedContent) {
        selectedContent.classList.remove('hidden');
    }

    // Add active class to selected tab button
    const selectedBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
    if (selectedBtn) {
        selectedBtn.classList.add('active', 'text-cool-primary', 'dark:text-cool-accent', 'border-cool-primary', 'dark:border-cool-accent', 'font-semibold');
        selectedBtn.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent', 'font-medium');
    }

    // Load addresses if switching to address tab
    if (tabName === 'address') {
        loadAddresses();
    }
}

function toggleDarkMode() {
    document.documentElement.classList.toggle('dark');
    const isDark = document.documentElement.classList.contains('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    updateDarkModeIcon(isDark);

    // Show notification
    showNotification(isDark ? 'ðŸŒ™ Dark Mode Aktif' : 'â˜€ï¸ Light Mode Aktif', 'success');
}

function updateDarkModeIcon(isDark) {
    const icons = document.querySelectorAll('.toggle-circle i');
    icons.forEach(icon => {
        if (isDark) {
            icon.className = 'fas fa-moon text-blue-300 text-xs';
        } else {
            icon.className = 'fas fa-sun text-yellow-500 text-xs';
        }
    });
}

function applyInitialTheme() {
    const theme = localStorage.getItem('theme') || 'light';

    logDebug(`Menerapkan tema awal: ${theme}`);

    if (theme === 'dark') {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }

    updateDarkModeIcon(theme === 'dark');
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification-popup');
    const msgText = document.getElementById('notification-text');
    const icon = document.getElementById('notification-icon');

    if (!notification || !msgText || !icon) {
        console.log(`Notifikasi: ${message}`);
        return;
    }

    // Remove all previous classes
    notification.classList.remove('hidden', 'opacity-0');
    const notificationDiv = notification.firstElementChild;
    notificationDiv.classList.remove('border-green-500', 'border-red-500', 'border-blue-500', 'border-yellow-500');

    // Set icon and border color based on type
    if (type === 'success') {
        notificationDiv.classList.add('border-green-500');
        icon.innerHTML = '<div class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center"><i class="fas fa-check text-green-600 dark:text-green-400"></i></div>';
    } else if (type === 'error') {
        notificationDiv.classList.add('border-red-500');
        icon.innerHTML = '<div class="w-8 h-8 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center"><i class="fas fa-times text-red-600 dark:text-red-400"></i></div>';
    } else if (type === 'info') {
        notificationDiv.classList.add('border-blue-500');
        icon.innerHTML = '<div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center"><i class="fas fa-info text-blue-600 dark:text-blue-400"></i></div>';
    } else if (type === 'warning') {
        notificationDiv.classList.add('border-yellow-500');
        icon.innerHTML = '<div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900 rounded-full flex items-center justify-center"><i class="fas fa-exclamation text-yellow-600 dark:text-yellow-400"></i></div>';
    }

    msgText.textContent = message;

    // Show with animation
    setTimeout(() => {
        notification.classList.remove('opacity-0', 'translate-y-2');
    }, 10);

    // Auto hide after 3 seconds
    setTimeout(() => {
        notification.classList.add('opacity-0', 'translate-y-2');
        setTimeout(() => {
            notification.classList.add('hidden');
        }, 300);
    }, 3000);
}

showNotification.dismiss = () => {
    const notification = document.getElementById('notification-popup');
    if (notification) {
        notification.classList.add('opacity-0', 'translate-y-2');
        setTimeout(() => {
            notification.classList.add('hidden');
        }, 300);
    }
};


function formatPhoneNumber(phone) {
    if (!phone || phone === 'N/A') return 'N/A';
    
    // 1. Bersihkan semua karakter non-digit kecuali +
    let cleaned = phone.replace(/[^\d+]/g, ''); 
    
    // 2. Hapus prefiks internasional (+62, 62) dan ganti angka 8 pertama dengan 0
    // Asumsi: Nomor telepon Indonesia yang valid dimulai dengan +628 atau 628 atau 08
    if (cleaned.startsWith('+62')) {
        // Hapus +62 dan pastikan 0 di awal (misal: +62812... menjadi 0812...)
        cleaned = '' + cleaned.substring(3); 
    } else if (cleaned.startsWith('62')) {
        // Hapus 62 dan pastikan 0 di awal (misal: 62812... menjadi 0812...)
        cleaned = '' + cleaned.substring(2); 
    } else if (cleaned.startsWith('8')) {
        // Jika hanya 8 (misal: 812...), tambahkan 0 di awal (menjadi 0812...)
        cleaned = '0' + cleaned;
    } 
    // Jika sudah diawali 08, biarkan saja.

    // 3. Terapkan format pemisah (Contoh: 0812-3456-7890)
    // Regex mencari 2 digit awal (08), 3-4 digit berikutnya, dan sisa digit
    let formatted = cleaned.replace(/^('0'\d{3,4})(\d{4,5})(.+)?$/, '$1-$2-$3$4');

    return formatted.trim();
}

// ===================================
// FUNGSI INTERAKSI API
// ===================================

async function fetchUserData() {
    logDebug('Memulai fetchUserData...');
    const token = getAuthToken();
    if (!token) {
        logDebug('Token tidak ada. Mengalihkan.', 'warn');
        showNotification('Anda belum login. Mengalihkan...', 'warning');
        setTimeout(() => { window.location.href = 'login.html'; }, 1500);
        return;
    }

    try {
        logDebug(`Mengambil data profil dari: ${BASE_URL}/api/profile`);
        const response = await fetch(`${BASE_URL}/api/profile`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.status === 403 || response.status === 401) {
            logDebug(`Gagal memuat profil: Unauthorized (Status ${response.status})`, 'error');
        }

        const result = await response.json();
        logDebug('Data profil berhasil dimuat:', 'debug');
        console.log(result); // Tampilkan detail data yang diterima

        // Update State
        appState.userName = result.name || 'Pengguna E-commerce';
        appState.userEmail = result.email || 'N/A';
        appState.userPhone = result.phone || 'N/A';

        // Update Form dan Display
        elements.displayUserName.textContent = appState.userName;
        elements.displayUserPhone.textContent = formatPhoneNumber(appState.userPhone);
        elements.inputName.value = appState.userName;
        elements.inputEmail.value = appState.userEmail;
        elements.inputPhone.value = appState.userPhone;

    } catch (error) {
        logDebug(`Kesalahan saat fetchUserData: ${error.message}`, 'error');
        if (error.message === 'Unauthorized') {
            alert('Sesi Anda telah berakhir. Silakan login ulang.');
            showNotification('Sesi berakhir, silakan login ulang.', 'error');
            setTimeout(() => { window.location.href = 'login.html'; }, 1500);
        } else {
            showNotification('Gagal memuat data profil. Pastikan server berjalan dan API terhubung.', 'error');
            elements.displayUserName.textContent = 'Gagal Memuat';
            elements.displayUserPhone.textContent = 'Gagal Memuat';
        }
    }
}


async function handleProfileSubmit(event) {
    event.preventDefault();
    
    // Pengecekan Kritis Elemen Form (Sinkronisasi properti elements: profileForm, inputName, inputEmail, inputBirthdate)
    if (!elements.profileForm || !elements.inputName || !elements.inputEmail) {
        logDebug('Error: Salah satu elemen form atau input (profileForm, inputName, inputEmail, inputBirthdate) tidak ditemukan di DOM. Periksa ID HTML.', 'error');
        // Panggilan showMessage diperbaiki dengan tipe eksplisit
        showNotification('Error inisialisasi form. Periksa ID elemen HTML Anda.', true, 'error');
        return;
    }

    const saveButton = elements.profileForm.querySelector('button[type="submit"]');

    // 1. Validasi Token
    const authToken = localStorage.getItem('authToken');
    if (!authToken) {
        logDebug('Auth Token tidak ditemukan. Mengarahkan ke login.', 'error');
        showNotification('Sesi berakhir. Mohon login kembali.', true, 'error');
        setTimeout(() => window.location.href = 'login.html', 1500);
        return;
    }

    // 2. Ambil Data Form (Menggunakan properti elements yang disinkronkan)
    const name = elements.inputName.value.trim();
    const email = elements.inputEmail.value.trim();
    const birthdate = elements.inputBirthdate.value;

    if (!name || !email || !birthdate ) {
        showNotification('Nama, Email, dan Tanggal Lahir wajib diisi.', true, 'error');
        return;
    }

    // Payload dipertahankan sesuai form yang ada di profile.js (name, email, birthdate)
    const dataToSend = { name, email, birthdate }; 
    
    logDebug('Form Profile disubmit. Memulai update...');
    logDebug('Data Profil yang akan dikirim: ' + JSON.stringify(dataToSend));
    
    // Nonaktifkan tombol dan tampilkan loading
    if (saveButton) saveButton.disabled = true;
    showMessage('Menyimpan perubahan...', false, 'info'); 

    try {
        logDebug(`Mengirim PUT request ke: ${BASE_URL}/api/profile`);
        const res = await fetch(`${BASE_URL}/api/profile`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(dataToSend)
        });

        // MEMPERTAHANKAN LOGIKA AMAN: Menggunakan res.text() untuk mencegah error 'Unexpected token <'
        const responseText = await res.text();
        let data = {};
        
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            // Ini terjadi jika server mengembalikan HTML (404/500)
            logDebug(`Kesalahan saat handleProfileSubmit: Respon bukan JSON. Respon Awal: ${responseText.substring(0, 50)}...`, 'error');
            // PERBAIKAN: Pesan lebih eksplisit saat server mengembalikan HTML
            showNotification('Kesalahan Server: Server mengembalikan respons HTML, bukan data JSON. Pastikan **Server API berjalan** dan endpoint **PUT /api/profile** sudah didefinisikan.', true, 'error');
            return; 
        }
        
        if (res.ok) {
            logDebug('Update Profil BERHASIL.', 'info');
            showNotification(data.message || 'Informasi profil berhasil diperbarui!', false, 'success');
            
            // Update state lokal dan UI
            appState.userName = name;
            appState.userEmail = email;
            appState.userBirthdate = birthdate;
          //  updateProfileUI(); // Refresh nama di header
            
        } else {
            // Penanganan status error
            let errorMessage = data.error || 'Gagal menyimpan data. Coba lagi.';
            
            if (res.status === 404) {
                errorMessage = 'Gagal menyimpan profil: Rute API tidak ditemukan (404 Not Found). Pastikan endpoint server Anda (PUT /api/profile) sudah benar.';
            } else if (res.status === 401) {
                errorMessage = 'Otorisasi gagal (401). Mohon login kembali.';
            }
            logDebug(`Update Profil GAGAL. Status: ${res.status}. Pesan Error: ${errorMessage}`, 'error');
            showNotification(errorMessage, true, 'error');
        }
    } catch (error) {
        // Kesalahan jaringan murni
        logDebug(`Kesalahan Fetch/Jaringan saat submit: ${error.message}`, 'error');
        showNotification('Terjadi kesalahan jaringan. Periksa koneksi Anda.', true, 'error');
    } finally {
        if (saveButton) saveButton.disabled = false;
        showNotification.dismiss('info'); // Tutup pesan 'Menyimpan perubahan...'
    }
}


// --- Manajemen Alamat ---

function renderAddressCard(address, isMain) {
    // ... (fungsi ini tetap, tidak perlu logging karena hanya rendering) ...
    const fullAddressText = `${address.address_detail}, ${address.city}`; // Sesuaikan dengan field di backend
    
    return `
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-inner border border-gray-200 dark:border-gray-600 ${isMain ? 'border-4 border-cool-primary dark:border-cool-accent' : ''}" data-id="${address.id}">
            <div class="flex justify-between items-start mb-2">
                <span class="font-bold text-lg text-cool-primary dark:text-cool-accent">${address.label}</span>
                ${isMain ? '<span class="text-xs font-medium bg-cool-primary text-white px-2 py-0.5 rounded-full">Utama</span>' : ''}
            </div>
            <p class="text-sm text-gray-800 dark:text-gray-300">${address.recipient_name} (${formatPhoneNumber(appState.userPhone)})</p> 
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${fullAddressText}</p>
            <div class="mt-4 flex space-x-2">
                <button data-id="${address.id}" class="edit-address-btn text-cool-primary dark:text-cool-accent hover:text-blue-700 transition duration-150 text-sm font-medium">Edit</button>
                <span class="text-gray-400 dark:text-gray-500">|</span>
                <button data-id="${address.id}" class="delete-address-btn text-red-600 hover:text-red-700 transition duration-150 text-sm font-medium">Hapus</button>
                ${!isMain ? `
                    <span class="text-gray-400 dark:text-gray-500">|</span>
                    <button data-id="${address.id}" class="set-main-address-btn text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition duration-150 text-sm font-medium">Jadikan Utama</button>
                ` : ''}
            </div>
        </div>
    `;
}

async function loadAddresses() {
    logDebug('Memulai loadAddresses...');
    const token = getAuthToken();
    if (!token) { 
        logDebug('Token tidak ada saat loadAddresses.', 'warn');
        elements.addressList.innerHTML = '<p class="text-red-500 dark:text-red-400 col-span-full">Autentikasi gagal. Silakan login ulang.</p>';
        return; 
    }
    
    elements.addressList.innerHTML = `<p id="loadingAddress" class="text-gray-500 dark:text-gray-400 col-span-full"><i class="fas fa-spinner fa-spin mr-2"></i> Memuat alamat...</p>`;

    try {
        logDebug(`Mengambil data alamat dari: ${BASE_URL}/api/addresses`);
        const response = await fetch(`${BASE_URL}/api/addresses`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.status === 403 || response.status === 401) {
            logDebug(`Gagal memuat alamat: Unauthorized (Status ${response.status})`, 'error');
            throw new Error('Unauthorized');
        }

        const addresses = await response.json();
        appState.addresses = addresses; // Update state
        logDebug(`Data alamat berhasil dimuat. Total: ${addresses.length}`, 'info');
        console.log(addresses); // Tampilkan daftar alamat

        elements.addressList.innerHTML = ''; 
        
        if (addresses.length === 0) {
            elements.addressList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full">Anda belum memiliki alamat tersimpan.</p>';
        } else {
            addresses.forEach(address => {
                const isMain = address.is_main === 1; // Backend mengembalikan 1 atau 0
                elements.addressList.innerHTML += renderAddressCard(address, isMain);
            });
        }

    } catch (error) {
        logDebug(`Kesalahan saat loadAddresses: ${error.message}`, 'error');
        if (error.message === 'Unauthorized') {
            showNotification('Sesi berakhir, silakan login ulang.', 'error');
            setTimeout(() => { window.location.href = '#'; }, 1500); 
        } else {
            elements.addressList.innerHTML = '<p class="text-red-600 dark:text-red-400 col-span-full"><i class="fas fa-exclamation-circle mr-2"></i> Gagal memuat alamat. Server Error.</p>';
        }
    }
}

async function handleAddressSubmit(event) {
    event.preventDefault();
    const token = getAuthToken();
    if (!token) { showMessage('Silakan login ulang.', 'warning'); return; }

    const isEditing = elements.addressModal.dataset.editId;
    
    const addressData = {
        label: elements.addressLabel.value,
        recipient_name: elements.receiverName.value,
        address_detail: elements.fullAddress.value,
        city: 'Kota Contoh', 
        is_main: false,
    };
    
    try {
        let response;
        let method, url;
        
        if (isEditing) {
            method = 'PUT';
            url = `${BASE_URL}/api/addresses/${isEditing}`;
            logDebug(`Memulai EDIT alamat (ID: ${isEditing}). URL: ${url}`, 'info');
        } else {
            method = 'POST';
            url = `${BASE_URL}/api/addresses`;
            logDebug(`Memulai TAMBAH alamat baru. URL: ${url}`, 'info');
        }
        
        logDebug('Data Alamat yang dikirim:', 'debug');
        console.log(addressData);

        response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(addressData)
        });
        
        const result = await response.json();
        logDebug(`Respon submit alamat. Status: ${response.status}`);

        if (!response.ok) {
             throw new Error(result.error || 'Gagal menyimpan alamat.');
        }

        showNotification(`Alamat ${addressData.label} berhasil ${isEditing ? 'diperbarui' : 'ditambahkan'}.`, 'success');

    } catch (error) {
        logDebug(`Kesalahan saat handleAddressSubmit: ${error.message}`, 'error');
        showNotification(`Gagal menyimpan alamat: ${error.message}`, 'error');
    }

    delete elements.addressModal.dataset.editId; 
    elements.addressFormModal.reset(); 
    hideModal(elements.addressModal);
    loadAddresses(); // Muat ulang daftar
}

function showAddAddressModal() {
    logDebug('Menampilkan modal Tambah Alamat Baru');
    window.location= 'setup_profile.html';
    elements.modalTitle.textContent = 'Tambah Alamat Baru';
}

function editAddress(id) {
    const addressToEdit = appState.addresses.find(addr => addr.id == id);
    if (!addressToEdit) {
        logDebug(`Alamat ID ${id} tidak ditemukan dalam state.`, 'warn');
        return;
    }
    logDebug(`Memuat data alamat ID ${id} untuk diedit.`, 'info');

    window.location= 'setup_profile.html';
}

async function deleteAddress(id) {
    logDebug(`Memulai proses DELETE alamat ID: ${id}`);
    const token = getAuthToken();
    if (!token) { showMessage('Silakan login ulang.', 'warning'); hideDeleteConfirm(); return; }

    try {
        const url = `${BASE_URL}/api/addresses/${id}`;
        logDebug(`Mengirim DELETE request ke: ${url}`);
        const response = await fetch(url, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        const result = await response.json();
        logDebug(`Respon DELETE alamat. Status: ${response.status}`);

        if (!response.ok) {
             throw new Error(result.error || 'Gagal menghapus alamat.');
        }

        showNotification('Alamat berhasil dihapus.', 'success');

    } catch (error) {
        logDebug(`Kesalahan saat deleteAddress: ${error.message}`, 'error');
        showNotification(`Gagal menghapus alamat: ${error.message}`, 'error');
    }
    
    hideDeleteConfirm();
    loadAddresses(); // Muat ulang daftar
}

async function setMainAddress(id) {
    logDebug(`Memulai proses SET UTAMA alamat ID: ${id}`);
    const token = getAuthToken();
    if (!token) { showMessage('Silakan login ulang.', 'warning'); return; }

    const addressToSet = appState.addresses.find(addr => addr.id == id);
    if (!addressToSet) return;
    
    // Kirim request PUT untuk mengupdate alamat menjadi is_main = 1
    const updateData = {
        label: addressToSet.label,
        recipient_name: addressToSet.recipient_name,
        address_detail: addressToSet.address_detail,
        city: addressToSet.city,
        // postal_code: addressToSet.postal_code, // Asumsi ini ada
        is_main: 1 // SET UTAMA
    };
    
    try {
        const url = `${BASE_URL}/api/addresses/${id}`;
        logDebug(`Mengirim PUT request (Set Utama) ke: ${url}`, 'info');
        console.log(updateData);
        
        const response = await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(updateData)
        });

        const result = await response.json();
        logDebug(`Respon Set Utama. Status: ${response.status}`);

        if (!response.ok) {
             throw new Error(result.error || 'Gagal menjadikan alamat utama.');
        }

        showNotification('Alamat berhasil dijadikan utama!', 'success');
        
    } catch (error) {
        logDebug(`Kesalahan saat setMainAddress: ${error.message}`, 'error');
        showNotification(`Gagal menjadikan alamat utama: ${error.message}`, 'error');
    }

    loadAddresses(); // Muat ulang daftar untuk update tampilan
}


function showDeleteConfirm(id) {
    logDebug(`Menampilkan konfirmasi hapus untuk ID: ${id}`);
    deleteTargetId = id;
    showModal(elements.deleteConfirmModal);
}

function hideDeleteConfirm() {
    logDebug('Menyembunyikan konfirmasi hapus.');
    deleteTargetId = null;
    hideModal(elements.deleteConfirmModal);
}

function showLogoutConfirm() {
    logDebug('Menampilkan konfirmasi logout.');
    showModal(elements.logoutConfirmModal);
}

function hideLogoutConfirm() {
    logDebug('Menyembunyikan konfirmasi logout.');
    hideModal(elements.logoutConfirmModal);
}

function showMessage(message, type = 'info') {
    logDebug(`Notifikasi UI: ${message} (Tipe: ${type})`, type === 'error' ? 'error' : 'info');
    // Redirect to showNotification function
    showNotification(message, type);
}

function handleLogout() {
    logDebug("Melakukan proses logout (Menghapus token sesi).", 'warn');
    localStorage.removeItem('authToken'); // Pastikan kunci ini benar
    hideLogoutConfirm();
    showMessage('Anda telah berhasil logout! Mengalihkan ke halaman utama.', 'success');
    setTimeout(() => { window.location.href = 'index.html'; }, 1500); 
}

// Menghubungkan Event Delegation untuk tombol Edit/Hapus
function setupAddressEventListeners() {
    logDebug('Mengaktifkan Event Listeners untuk manajemen alamat (Delegation).');
    elements.addressList.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        
        const id = target.dataset.id;
        if (!id) return;
        
        logDebug(`Tombol interaksi alamat diklik. ID: ${id}. Class: ${target.className.split(' ')[0]}`);

        if (target.classList.contains('delete-address-btn')) {
            showDeleteConfirm(id);
        } else if (target.classList.contains('edit-address-btn')) {
            editAddress(id);
        } else if (target.classList.contains('set-main-address-btn')) {
            setMainAddress(id);
        }
    });
}

// --- Inisialisasi Utama ---

function init() {
    logDebug('Aplikasi Mulai diinisialisasi.', 'info');
    initElements();
    applyInitialTheme();

    // Muat data profil dan alamat
    fetchUserData();
    loadAddresses();

    // Event Listeners Dasar
    const darkModeToggle = document.getElementById('darkModeToggle');

    if (darkModeToggle) {
        darkModeToggle.addEventListener('click', toggleDarkMode);
    }

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.getAttribute('data-tab');
            switchTab(tabName);
        });
    });

    elements.profileForm.addEventListener('submit', handleProfileSubmit);

    // Event Listeners untuk Modal Alamat
    elements.addAddressBtn.addEventListener('click', showAddAddressModal);
    elements.closeAddressModal.addEventListener('click', () => hideModal(elements.addressModal));
    elements.addressFormModal.addEventListener('submit', handleAddressSubmit);

    // Event Listeners untuk Edit/Hapus Alamat (menggunakan delegation)
    setupAddressEventListeners();

    // Konfirmasi Hapus
    elements.confirmDeleteBtn.addEventListener('click', () => {
        if (deleteTargetId !== null) {
            deleteAddress(deleteTargetId);
        }
    });
    elements.cancelDeleteBtn.addEventListener('click', hideDeleteConfirm);

    // Konfirmasi Logout
    elements.confirmLogoutBtn.addEventListener('click', handleLogout);
    elements.cancelLogoutBtn.addEventListener('click', hideLogoutConfirm);

    // Logout Button (single button in profile form)
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', showLogoutConfirm);
    }

    logDebug('Inisialisasi selesai. Menunggu interaksi pengguna.', 'info');
}

// Jalankan inisialisasi saat halaman selesai dimuat
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
