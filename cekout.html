<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keranjang Belanja | AnterTah</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'cool-primary': '#1d4ed8',
                        'cool-accent': '#06b6d4',
                        'bg-light': '#f1f5f9',
                        'bg-dark': '#0f172a',
                        'card-light': '#ffffff',
                        'card-dark': '#1e293b',
                        'text-light': '#f1f5f9',
                        'text-dark': '#1e293b',
                        'neutral-text': '#64748b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'slide-in-right': 'slideInRight 0.4s ease-out',
                        'bounce-in': 'bounceIn 0.6s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.3)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)' },
                            '70%': { transform: 'scale(0.9)' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                    }
                }
            }
        }
    </script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .cart-item {
            transition: all 0.3s ease;
        }

        .cart-item:hover {
            transform: translateX(4px);
        }

        .quantity-btn {
            transition: all 0.2s ease;
        }

        .quantity-btn:active {
            transform: scale(0.9);
        }

        .floating-checkout {
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.1);
        }

        .dark .floating-checkout {
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Remove spinner from number input */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .empty-cart-animation {
            animation: bounceIn 0.8s ease-out;
        }

        .promo-input:focus {
            box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.1);
        }

        .address-card {
            transition: all 0.3s ease;
        }

        .address-card:hover {
            transform: translateY(-2px);
        }

        .address-card.selected {
            border-color: #1d4ed8;
            background-color: rgba(29, 78, 216, 0.05);
        }

        .dark .address-card.selected {
            background-color: rgba(6, 182, 212, 0.1);
        }

        .no-address-selected {
            border: 2px dashed #cbd5e1;
            background-color: rgba(248, 250, 252, 0.5);
        }

        .dark .no-address-selected {
            border-color: #475569;
            background-color: rgba(30, 41, 59, 0.5);
        }
    </style>
</head>
<body class="bg-bg-light dark:bg-bg-dark text-text-dark dark:text-text-light min-h-screen font-sans pb-32 md:pb-8">
    
    <!-- Header -->
    <header class="bg-card-light dark:bg-card-dark shadow-lg sticky top-0 z-50 backdrop-blur-md bg-opacity-95">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <button onclick="window.history.back()" class="text-neutral-text dark:text-gray-300 hover:text-cool-primary dark:hover:text-cool-accent transition">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                
                <h1 class="text-xl font-bold text-text-dark dark:text-text-light">Keranjang Belanja</h1>
                
                <button id="clear-cart-btn" class="text-red-500 hover:text-red-600 transition text-sm font-semibold">
                    <i class="fas fa-trash-alt mr-1"></i>
                    <span class="hidden sm:inline">Kosongkan</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- Cart Items Container -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Section: Cart Items -->
            <div class="lg:col-span-2">
                <div id="cart-items-container" class="space-y-4">
                    <!-- Cart items will be rendered here -->
                </div>

                <!-- Empty Cart State -->
                <div id="empty-cart-state" class="hidden text-center py-16 animate-fade-in">
                    <div class="empty-cart-animation">
                        <i class="fas fa-shopping-cart text-gray-300 dark:text-gray-600 text-8xl mb-6"></i>
                        <h3 class="text-2xl font-bold mb-2 text-gray-600 dark:text-gray-400">Keranjang Kosong</h3>
                        <p class="text-neutral-text mb-6">Belum ada item di keranjang Anda</p>
                        <a href="home.html" class="inline-block bg-gradient-to-r from-cool-primary to-blue-600 text-white font-semibold px-8 py-3 rounded-xl hover:shadow-lg transition-all transform hover:scale-105">
                            <i class="fas fa-utensils mr-2"></i>
                            Mulai Belanja
                        </a>
                    </div>
                </div>

                <!-- Address Selection Section -->
                <div id="address-section" class="mt-6 hidden">
                    <div class="bg-card-light dark:bg-card-dark rounded-2xl shadow-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold flex items-center">
                                <i class="fas fa-map-marker-alt mr-2 text-cool-primary dark:text-cool-accent"></i>
                                Alamat Pengiriman
                                <span id="address-required-badge" class="ml-2 text-xs bg-red-500 text-white px-2 py-1 rounded">Wajib Dipilih</span>
                            </h3>
                            <button id="add-new-address-btn" class="text-cool-primary dark:text-cool-accent font-semibold text-sm hover:underline">
                                <i class="fas fa-plus-circle mr-1"></i>
                                Tambah Alamat Baru
                            </button>
                        </div>
                        
                        <!-- No Address Selected State -->
                        <div id="no-address-selected" class="no-address-selected rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition" onclick="openAddressModal()">
                            <i class="fas fa-map-pin text-4xl text-neutral-text mb-3"></i>
                            <p class="text-neutral-text font-medium">Belum ada alamat dipilih</p>
                            <p class="text-sm text-neutral-text mt-1">Klik untuk memilih alamat pengiriman</p>
                        </div>
                        
                        <div id="addresses-container" class="space-y-3 mb-4 hidden">
                            <!-- Addresses will be loaded here -->
                        </div>
                        
                        <div id="no-addresses" class="hidden text-center py-8">
                            <i class="fas fa-map-marker-alt text-gray-300 dark:text-gray-600 text-5xl mb-4"></i>
                            <p class="text-neutral-text mb-4">Belum ada alamat tersimpan</p>
                            <button onclick="window.location.href='profile.html#addresses'" class="bg-cool-primary hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg transition-all">
                                <i class="fas fa-plus mr-2"></i>
                                Tambah Alamat
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Section: Summary -->
            <div class="lg:col-span-1">
                <div id="cart-summary" class="bg-card-light dark:bg-card-dark rounded-2xl shadow-xl p-6 sticky top-24 animate-slide-in-right">
                    
                    <!-- Promo Code Section -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold mb-2">Kode Promo</label>
                        <div class="flex space-x-2">
                            <input type="text" id="promo-input" placeholder="Masukkan kode promo" 
                                   class="promo-input flex-1 px-4 py-2.5 border-2 border-gray-200 dark:border-gray-600 rounded-lg text-sm focus:outline-none focus:border-cool-primary dark:bg-gray-700 dark:text-text-light transition-all">
                            <button id="apply-promo-btn" class="bg-cool-primary hover:bg-blue-700 text-white font-semibold px-6 py-2.5 rounded-lg transition-all transform hover:scale-105">
                                Pakai
                            </button>
                        </div>
                        <div id="promo-message" class="mt-2 text-sm hidden"></div>
                    </div>

                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <h3 class="text-lg font-bold mb-4">Ringkasan Belanja</h3>
                        
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-neutral-text">Subtotal (<span id="item-count">0</span> item)</span>
                                <span class="font-semibold" id="subtotal">Rp 0</span>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-neutral-text">Ongkos Kirim</span>
                                <span class="font-semibold text-green-600" id="shipping-cost">Rp 10.000</span>
                            </div>

                            <div id="discount-row" class="flex justify-between text-sm hidden">
                                <span class="text-neutral-text">Diskon</span>
                                <span class="font-semibold text-red-500" id="discount-amount">- Rp 0</span>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-6">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold">Total</span>
                                <span class="text-2xl font-bold text-cool-primary dark:text-cool-accent" id="total">Rp 0</span>
                            </div>
                        </div>

                        <button id="checkout-btn" class="w-full bg-gradient-to-r from-cool-primary to-blue-600 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-105 shadow-lg hover:shadow-xl mb-3">
                            <i class="fas fa-credit-card mr-2"></i>
                            Lanjut ke Pembayaran
                        </button>

                        <a href="home.html" class="block text-center text-cool-primary dark:text-cool-accent font-semibold hover:underline">
                            <i class="fas fa-arrow-left mr-1"></i>
                            Lanjut Belanja
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Floating Checkout -->
    <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-card-light dark:bg-card-dark floating-checkout p-4 z-40">
        <div class="flex items-center justify-between mb-3">
            <div>
                <p class="text-xs text-neutral-text">Total Pembayaran</p>
                <p class="text-xl font-bold text-cool-primary dark:text-cool-accent" id="mobile-total">Rp 0</p>
            </div>
            <button id="mobile-checkout-btn" class="bg-gradient-to-r from-cool-primary to-blue-600 hover:from-blue-700 hover:to-blue-800 text-white font-bold px-8 py-3 rounded-xl transition-all shadow-lg">
                Checkout
            </button>
        </div>
    </div>

    <!-- Address Modal -->
    <div id="address-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-card-light dark:bg-card-dark rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto p-6 animate-bounce-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Pilih Alamat Pengiriman</h3>
                <button id="close-address-modal" class="text-neutral-text hover:text-red-500 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="modal-addresses-container" class="space-y-3 mb-4">
                <!-- Addresses will be loaded here -->
            </div>
            
            <div id="modal-no-addresses" class="hidden text-center py-8">
                <i class="fas fa-map-marker-alt text-gray-300 dark:text-gray-600 text-5xl mb-4"></i>
                <p class="text-neutral-text mb-4">Belum ada alamat tersimpan</p>
                <button onclick="window.location.href='profile.html#addresses'" class="bg-cool-primary hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg transition-all">
                    <i class="fas fa-plus mr-2"></i>
                    Tambah Alamat
                </button>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-address-selection" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                    Batal
                </button>
                <button id="confirm-address-selection" class="px-6 py-2 bg-cool-primary hover:bg-blue-700 text-white rounded-lg transition">
                    Konfirmasi
                </button>
            </div>
        </div>
    </div>

<script src="config.js"></script>
    <script>
        
        const SHIPPING_COST = 10000;
        
        let cart = [];
        let appliedPromo = null;
        let addresses = [];
        let selectedAddress = null;
        
        // Promo codes database
        const promoCodes = {
            'ANT50': { type: 'percentage', value: 50, minPurchase: 0 },
            'WELCOME20': { type: 'percentage', value: 20, minPurchase: 50000 },
            'HEMAT25K': { type: 'fixed', value: 25000, minPurchase: 100000 },
        };

        // ========== LOAD CART FROM API ==========
        async function loadCart() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.warn('No auth token found');
                    cart = [];
                    renderCart();
                    updateSummary();
                    return;
                }
                
                const res = await fetch(`${BASE_URL}/api/cart`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Gagal memuat cart');
                const data = await res.json();
                cart = (data.items || []).map(it => ({
                    id: it.item_id,
                    name: it.name,
                    price: it.price,
                    quantity: it.quantity,
                    image_url: it.image_url
                }));
                renderCart();
                updateSummary();
            } catch (e) {
                console.error('Load cart error:', e);
                showNotification('‚ö†Ô∏è Gagal memuat keranjang', 'error');
                cart = [];
                renderCart();
                updateSummary();
            }
        }

        // ========== LOAD ADDRESSES FROM API ==========
        async function loadAddresses() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.warn('No auth token found');
                    addresses = [];
                    renderAddresses();
                    return;
                }
                
                const res = await fetch(`${BASE_URL}/api/addresses`, { 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                
                if (!res.ok) throw new Error('Gagal memuat alamat');
                const data = await res.json();
                addresses = data || [];
                
                // NO AUTO-SELECTION - User must manually select
                selectedAddress = null;
                
                renderAddresses();
            } catch (e) {
                console.error('Load addresses error:', e);
                showNotification('‚ö†Ô∏è Gagal memuat alamat', 'error');
                addresses = [];
                renderAddresses();
            }
        }

        // ========== RENDER ADDRESSES ==========
        function renderAddresses() {
            const container = document.getElementById('addresses-container');
            const noAddresses = document.getElementById('no-addresses');
            const addressSection = document.getElementById('address-section');
            const modalContainer = document.getElementById('modal-addresses-container');
            const modalNoAddresses = document.getElementById('modal-no-addresses');
            const noAddressSelected = document.getElementById('no-address-selected');

            if (addresses.length === 0) {
                container.innerHTML = '';
                modalContainer.innerHTML = '';
                noAddresses.classList.remove('hidden');
                modalNoAddresses.classList.remove('hidden');
                noAddressSelected.classList.add('hidden');
                return;
            }

            noAddresses.classList.add('hidden');
            modalNoAddresses.classList.add('hidden');
            addressSection.classList.remove('hidden');

            // Show/hide based on whether address is selected
            if (selectedAddress) {
                noAddressSelected.classList.add('hidden');
                container.classList.remove('hidden');
            } else {
                noAddressSelected.classList.remove('hidden');
                container.classList.add('hidden');
            }

            // Render selected address in main section
            if (selectedAddress) {
                container.innerHTML = '';
                const addressCard = document.createElement('div');
                addressCard.className = 'address-card border-2 border-cool-primary rounded-lg p-4 bg-blue-50 dark:bg-blue-900/20';
                
                addressCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <h4 class="font-semibold mr-2">${selectedAddress.label}</h4>
                                ${selectedAddress.is_main === 1 ? '<span class="text-xs bg-cool-primary text-white px-2 py-1 rounded">Utama</span>' : ''}
                            </div>
                            <p class="text-sm text-neutral-text mb-1">${selectedAddress.recipient_name}</p>
                            <p class="text-sm text-neutral-text">${selectedAddress.address_detail}, ${selectedAddress.city}, ${selectedAddress.postal_code}</p>
                        </div>
                        <button onclick="openAddressModal()" class="text-cool-primary hover:text-blue-700 font-semibold text-sm">
                            <i class="fas fa-edit mr-1"></i>
                            Ubah
                        </button>
                    </div>
                `;
                
                container.appendChild(addressCard);
            }

            // Render all addresses in modal
            modalContainer.innerHTML = '';
            addresses.forEach((address, index) => {
                const isSelected = selectedAddress && selectedAddress.id === address.id;
                const addressCard = document.createElement('div');
                addressCard.className = `address-card border-2 rounded-lg p-4 cursor-pointer ${isSelected ? 'selected' : 'border-gray-200 dark:border-gray-700'}`;
                addressCard.onclick = () => selectAddressInModal(address.id);
                
                addressCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <h4 class="font-semibold mr-2">${address.label}</h4>
                                ${address.is_main === 1 ? '<span class="text-xs bg-cool-primary text-white px-2 py-1 rounded">Utama</span>' : ''}
                            </div>
                            <p class="text-sm text-neutral-text mb-1">${address.recipient_name}</p>
                            <p class="text-sm text-neutral-text">${address.address_detail}, ${address.city}, ${address.postal_code}</p>
                        </div>
                        <div class="ml-3">
                            <div class="w-5 h-5 rounded-full border-2 ${isSelected ? 'border-cool-primary' : 'border-gray-300 dark:border-gray-600'} flex items-center justify-center">
                                ${isSelected ? '<div class="w-3 h-3 rounded-full bg-cool-primary"></div>' : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                modalContainer.appendChild(addressCard);
            });
        }

        // ========== SELECT ADDRESS ==========
        function selectAddress(addressId) {
            selectedAddress = addresses.find(addr => addr.id === addressId);
            renderAddresses();
        }

        function selectAddressInModal(addressId) {
            selectedAddress = addresses.find(addr => addr.id === addressId);
            renderAddresses();
        }

        // ========== OPEN ADDRESS MODAL ==========
        function openAddressModal() {
            document.getElementById('address-modal').classList.remove('hidden');
            renderAddresses();
        }

        // ========== RENDER CART ITEMS ==========
        function renderCart() {
            const container = document.getElementById('cart-items-container');
            const emptyState = document.getElementById('empty-cart-state');
            const summary = document.getElementById('cart-summary');

            if (cart.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                summary.classList.add('hidden');
                document.getElementById('address-section').classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            emptyState.classList.add('hidden');
            summary.classList.remove('hidden');
            container.innerHTML = '';

            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                const imageUrl = item.image_url || 'https://placehold.co/100x100/e2e8f0/64748b?text=No+Image';

                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item bg-card-light dark:bg-card-dark rounded-xl shadow-md p-4 flex items-center space-x-4 animate-slide-up';
                cartItem.style.animationDelay = `${index * 0.05}s`;

                cartItem.innerHTML = `
                    <div class="flex-shrink-0">
                        <img src="${imageUrl}" alt="${item.name}" class="w-20 h-20 object-cover rounded-lg">
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-base mb-1 truncate">${item.name}</h4>
                        <p class="text-xs text-neutral-text mb-2">
                            <i class="fas fa-tag mr-1"></i>
                            ${item.category || 'Lainnya'}
                        </p>
                        <p class="text-cool-primary dark:text-cool-accent font-bold text-lg">
                            Rp ${itemTotal.toLocaleString('id-ID')}
                        </p>
                    </div>

                    <div class="flex flex-col items-end space-y-2">
                        <!-- Quantity Controls -->
                        <div class="flex items-center space-x-2 bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
                            <button class="quantity-btn w-8 h-8 rounded-md bg-white dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center justify-center transition-all" onclick="updateQuantity(${index}, ${item.quantity - 1})">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <span class="w-10 text-center font-semibold">${item.quantity}</span>
                            <button class="quantity-btn w-8 h-8 rounded-md bg-white dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center justify-center transition-all" onclick="updateQuantity(${index}, ${item.quantity + 1})">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>

                        <!-- Remove Button -->
                        <button class="text-red-500 hover:text-red-600 text-sm font-semibold transition-all hover:scale-110" onclick="removeItem(${index})">
                            <i class="fas fa-trash-alt mr-1"></i>
                            Hapus
                        </button>
                    </div>
                `;

                container.appendChild(cartItem);
            });
        }

        // ========== UPDATE QUANTITY ==========
        async function updateQuantity(index, newQty) {
            if (newQty < 1) {
                removeItem(index);
                return;
            }

            if (newQty > 99) {
                showNotification('‚ö†Ô∏è Maksimal 99 item per produk', 'error');
                return;
            }

            const item = cart[index];
            const token = localStorage.getItem('authToken');
            
            if (token) {
                try {
                    const res = await fetch(`${BASE_URL}/api/cart/${item.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ quantity: newQty })
                    });
                    
                    if (!res.ok) throw new Error('Failed to update quantity');
                } catch (e) {
                    console.error('Update quantity error:', e);
                    showNotification('‚ö†Ô∏è Gagal memperbarui jumlah', 'error');
                    return;
                }
            }
            
            cart[index].quantity = newQty;
            saveCart();
            renderCart();
            updateSummary();
            showNotification('‚úÖ Jumlah diperbarui', 'success');
        }

        // ========== REMOVE ITEM ==========
        async function removeItem(index) {
            const itemName = cart[index].name;
            
            if (confirm(`Hapus "${itemName}" dari keranjang?`)) {
                const item = cart[index];
                const token = localStorage.getItem('authToken');
                
                if (token) {
                    try {
                        const res = await fetch(`${BASE_URL}/api/cart/${item.id}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (!res.ok) throw new Error('Failed to remove item');
                    } catch (e) {
                        console.error('Remove item error:', e);
                        showNotification('‚ö†Ô∏è Gagal menghapus item', 'error');
                        return;
                    }
                }
                
                cart.splice(index, 1);
                saveCart();
                renderCart();
                updateSummary();
                showNotification(`üóëÔ∏è "${itemName}" dihapus`, 'success');
            }
        }

        // ========== CLEAR CART ==========
        document.getElementById('clear-cart-btn').addEventListener('click', () => {
            if (cart.length === 0) {
                showNotification('‚ö†Ô∏è Keranjang sudah kosong', 'error');
                return;
            }

            if (confirm('Kosongkan semua item di keranjang?')) {
                cart = [];
                appliedPromo = null;
                selectedAddress = null; // Reset selected address when clearing cart
                saveCart();
                renderCart();
                updateSummary();
                renderAddresses();
                showNotification('üóëÔ∏è Keranjang dikosongkan', 'success');
            }
        });

        // ========== UPDATE SUMMARY ==========
        function updateSummary() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            let discount = 0;
            if (appliedPromo) {
                const promo = promoCodes[appliedPromo];
                if (promo.type === 'percentage') {
                    discount = Math.floor(subtotal * (promo.value / 100));
                } else {
                    discount = promo.value;
                }
            }

            const shipping = cart.length > 0 ? SHIPPING_COST : 0;
            const total = subtotal + shipping - discount;

            // Update UI
            document.getElementById('item-count').textContent = itemCount;
            document.getElementById('subtotal').textContent = `Rp ${subtotal.toLocaleString('id-ID')}`;
            document.getElementById('shipping-cost').textContent = shipping > 0 ? `Rp ${shipping.toLocaleString('id-ID')}` : 'GRATIS';
            document.getElementById('total').textContent = `Rp ${total.toLocaleString('id-ID')}`;
            document.getElementById('mobile-total').textContent = `Rp ${total.toLocaleString('id-ID')}`;

            // Show/hide discount row
            const discountRow = document.getElementById('discount-row');
            if (discount > 0) {
                discountRow.classList.remove('hidden');
                document.getElementById('discount-amount').textContent = `- Rp ${discount.toLocaleString('id-ID')}`;
            } else {
                discountRow.classList.add('hidden');
            }
        }

        // ========== PROMO CODE ==========
        document.getElementById('apply-promo-btn').addEventListener('click', () => {
            const promoInput = document.getElementById('promo-input');
            const promoCode = promoInput.value.trim().toUpperCase();
            const promoMessage = document.getElementById('promo-message');

            if (!promoCode) {
                showPromoMessage('‚ö†Ô∏è Masukkan kode promo', 'error');
                return;
            }

            if (!promoCodes[promoCode]) {
                showPromoMessage('‚ùå Kode promo tidak valid', 'error');
                return;
            }

            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const promo = promoCodes[promoCode];

            if (subtotal < promo.minPurchase) {
                showPromoMessage(`‚ö†Ô∏è Minimum pembelian Rp ${promo.minPurchase.toLocaleString('id-ID')}`, 'error');
                return;
            }

            appliedPromo = promoCode;
            updateSummary();
            promoInput.value = '';
            showPromoMessage(`‚úÖ Kode "${promoCode}" berhasil digunakan!`, 'success');
            showNotification(`üéâ Promo "${promoCode}" diterapkan!`, 'success');
        });

        function showPromoMessage(message, type) {
            const promoMessage = document.getElementById('promo-message');
            promoMessage.textContent = message;
            promoMessage.className = `mt-2 text-sm ${type === 'success' ? 'text-green-600' : 'text-red-500'}`;
            promoMessage.classList.remove('hidden');
            
            setTimeout(() => {
                promoMessage.classList.add('hidden');
            }, 3000);
        }

        // ========== CHECKOUT ==========
        async function proceedToCheckout() {
            if (cart.length === 0) {
                showNotification('‚ö†Ô∏è Keranjang masih kosong', 'error');
                return;
            }

            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                showNotification('‚ö†Ô∏è Silakan login terlebih dahulu', 'error');
                return;
            }

            // Check if address is selected
            if (!selectedAddress) {
                // Show address modal if no address is selected
                openAddressModal();
                showNotification('‚ö†Ô∏è Silakan pilih alamat pengiriman terlebih dahulu', 'error');
                return;
            }

            try {
                // Get user data from localStorage
                const userName = localStorage.getItem('userName') || 'Customer';
                const userPhone = localStorage.getItem('userPhone') || '';

                // Create order data
                const orderData = {
                    items: cart,
                    subtotal: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    shipping: SHIPPING_COST,
                    discount: appliedPromo ? calculateDiscount() : 0,
                    promoCode: appliedPromo,
                    total: calculateTotal(),
                    customer: {
                        name: userName,
                        phone: userPhone
                    },
                    address: selectedAddress,
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                };

                // Send order to backend
                const response = await fetch(`${BASE_URL}/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Store order data for payment page
                    localStorage.setItem('currentOrderId', result.orderId);
                    localStorage.setItem('currentOrder', JSON.stringify({
                        ...orderData,
                        id: result.orderId
                    }));
                    
                    // Redirect to payment page
                    window.location.href = `payment.html?orderId=${result.orderId}`;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to create order');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showNotification(`‚ùå ${error.message || 'Gagal membuat pesanan. Silakan coba lagi.'}`, 'error');
            }
        }

        // ========== SEND WHATSAPP NOTIFICATION ==========
        async function sendWhatsAppNotification(orderData, orderId) {
            try {
                // Create WhatsApp message
                const itemsText = orderData.items.map(item => 
                    `‚Ä¢ ${item.name} x${item.quantity} = Rp ${(item.price * item.quantity).toLocaleString()}`
                ).join('\n');

                const message = `üõí *PESANAN BARU - AnterTah*

üìã *Detail Pesanan:*
ID Pesanan: #${orderId}
Customer: ${orderData.customer.name}
No. HP: ${orderData.customer.phone}
Waktu: ${new Date().toLocaleString('id-ID')}

üõçÔ∏è *Items:*
 ${itemsText}

üí∞ *Ringkasan:*
Subtotal: Rp ${orderData.subtotal.toLocaleString()}
Ongkir: Rp ${orderData.shipping.toLocaleString()}
Diskon: Rp ${orderData.discount.toLocaleString()}
*TOTAL: Rp ${orderData.total.toLocaleString()}*

üìç *Alamat Pengiriman:*
 ${orderData.address.recipient_name}
 ${orderData.address.address_detail}, ${orderData.address.city}, ${orderData.address.postal_code}

üì± *Status:* Pending
‚è∞ *Estimasi:* 30-45 menit

Silakan segera proses pesanan ini! üöÄ`;

                // Send to WhatsApp API
                try {
                    const whatsappResponse = await fetch(`${BASE_URL}/api/whatsapp/send`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            orderId: orderId
                        })
                    });

                    if (whatsappResponse.ok) {
                        console.log('WhatsApp notification sent successfully');
                    } else {
                        const errorData = await whatsappResponse.json().catch(() => ({}));
                        console.error('Failed to send WhatsApp notification:', errorData.error || 'Unknown error');
                        // Continue with checkout flow even if WhatsApp fails
                        showNotification('‚ö†Ô∏è Notifikasi WhatsApp gagal dikirim, tapi pesanan Anda tetap diproses', 'warning');
                    }
                } catch (whatsappError) {
                    console.error('WhatsApp notification error:', whatsappError);
                    // Continue with checkout flow even if WhatsApp fails
                    showNotification('‚ö†Ô∏è Notifikasi WhatsApp gagal dikirim, tapi pesanan Anda tetap diproses', 'warning');
                }
            } catch (error) {
                console.error('WhatsApp notification error:', error);
            }
        }

        function calculateDiscount() {
            if (!appliedPromo) return 0;
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const promo = promoCodes[appliedPromo];
            
            if (promo.type === 'percentage') {
                return Math.floor(subtotal * (promo.value / 100));
            }
            return promo.value;
        }

        function calculateTotal() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discount = calculateDiscount();
            return subtotal + SHIPPING_COST - discount;
        }

        document.getElementById('checkout-btn').addEventListener('click', proceedToCheckout);
        document.getElementById('mobile-checkout-btn').addEventListener('click', proceedToCheckout);

        // ========== ADDRESS MODAL CONTROLS ==========
        document.getElementById('close-address-modal').addEventListener('click', () => {
            document.getElementById('address-modal').classList.add('hidden');
        });

        document.getElementById('cancel-address-selection').addEventListener('click', () => {
            document.getElementById('address-modal').classList.add('hidden');
        });

        document.getElementById('confirm-address-selection').addEventListener('click', () => {
            if (!selectedAddress) {
                showNotification('‚ö†Ô∏è Silakan pilih alamat terlebih dahulu', 'error');
                return;
            }
            document.getElementById('address-modal').classList.add('hidden');
            showNotification('‚úÖ Alamat berhasil dipilih', 'success');
        });

        document.getElementById('add-new-address-btn').addEventListener('click', () => {
            window.location.href = 'profile.html#addresses';
        });

        // ========== SAVE CART ==========
        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        // ========== NOTIFICATION ==========
        function showNotification(message, type = 'success') {
            const existing = document.querySelector('.notification-toast');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = 'notification-toast fixed top-20 right-4 z-[9999] animate-slide-up';
            
            let bgColor;
            if (type === 'success') {
                bgColor = 'bg-green-500';
            } else if (type === 'warning') {
                bgColor = 'bg-yellow-500';
            } else {
                bgColor = 'bg-red-500';
            }
            
            notification.innerHTML = `
                <div class="${bgColor} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center space-x-3">
                    <span class="text-sm font-medium">${message}</span>
                    <button onclick="this.closest('.notification-toast').remove()" class="ml-2 hover:opacity-80">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // ========== DARK MODE ==========
        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            document.documentElement.classList.add('dark');
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadCart();
            loadAddresses();
        });
    </script>
</body>
</html>